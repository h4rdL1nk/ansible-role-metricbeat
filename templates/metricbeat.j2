metricbeat.config:
  modules:
    path: ${path.config}/modules.d/*.yml
    reload.enabled: false

metricbeat.autodiscover:
  providers:
    - type: docker
      hints.enabled: true
      templates:
        - condition:
            equals:
              docker.container.labels.SERVICE_LABEL: ds1_gold
          config:
            - module: mongodb
              period: 5s
              metricsets: ["status","replstatus"]
              hosts: "${data.host}:30017"
        - condition:
            equals:
              docker.container.labels.SERVICE_LABEL: ds1_silver
          config:
            - module: mongodb
              period: 5s
              metricsets: ["status","replstatus"]
              hosts: "${data.host}:29017"
        - condition:
            equals:
              docker.container.labels.SERVICE_TYPE: etcd 
          config:
            - module: etcd 
              period: 5s
              metricsets: ["leader", "self", "metrics", "store"] 
              hosts: "${data.host}:2379"

# Modules configuration
metricbeat.modules:
- module: docker
  enabled: true
  period: 10s
  hosts: ["unix:///var/run/docker.sock"]
  metricsets:
    - container
    - cpu
    - diskio
    - healthcheck
    - info
    - image
    - memory
    - network
  
- module: system
  enabled: true
  period: 10s
  processes: ['.*']
  metricsets:
    - cpu
    - load
    - memory
    - network
    - process
    - process_summary
    - uptime
    - socket_summary
    - core
    - diskio
    - filesystem
    - fsstat
    - socket

    
#- module: elasticsearch
#- module: etcd
#- module: kibana
#- module: logstash
#- module: mongodb
#- module: nginx

processors:
  - add_cloud_metadata: ~

setup:
  kibana.host: "{{ kibana_cluster_network_addresses[0] }}:{{ kibana_network_port }}"
  kibana.protocol: "http"
  kibana.username: elastic 
  kibana.password:
  ilm:
    enabled: {{ metricbeat_setup_ilm }}
    pattern: "metricbeat-*"
  dashboards:
    enabled: {{ metricbeat_setup_dashboards }}
    index: "metricbeat-*"
  template:
    enabled: {{ metricbeat_setup_template }}
    name: "metricbeat-%{[agent.version]}"
    pattern: "metricbeat-*"

output.elasticsearch:
  enabled: {{ metricbeat_output_elasticsearch and not metricbeat_output_logstash }}
  protocol: "{% if elasticsearch_security_http_enabled %}https{% else %}http{% endif %}"
  hosts: [ {% for node in elasticsearch_cluster_network_addresses %}"{% if elasticsearch_security_http_enabled %}https{% else %}http{% endif %}://{{ node }}:{{ elasticsearch_network_port }}"{% if loop.index != elasticsearch_cluster_network_addresses|length %},{% endif %}{% endfor %} ]
  index: "metricbeat-%{[agent.version]}-%{+yyyy.MM.dd}"
  username: "${ES_USR}"
  password: "${ES_PWD}"
  ssl:
    verification_mode: none
    certificate_authorities: ["/usr/share/metricbeat/{{ elasticsearch_certificate_ca_file_ingest }}"]

output.logstash:
  enabled: {{ metricbeat_output_logstash }}
  loadbalance: true
  hosts: [ {% for node in logstash_cluster_network_addresses %}"{{ node }}:{{ logstash_network_port }}"{% if loop.index != logstash_cluster_network_addresses|length %},{% endif %}{% endfor %} ]
  index: "metricbeat-%{[agent.version]}-%{+yyyy.MM.dd}"
  ssl:
    verification_mode: none
    certificate_authorities: ["/usr/share/metricbeat/{{ elasticsearch_certificate_ca_file_ingest }}"]

xpack.monitoring:
  enabled: {{ metricbeat_monitoring_enable }} 
  elasticsearch:
    hosts: [ {% for node in metricbeat_elasticsearch_monitoring_hosts %}"{% if elasticsearch_security_http_enabled %}https{% else %}http{% endif %}://{{ node }}:{{ elasticsearch_network_port }}"{% if loop.index != metricbeat_elasticsearch_monitoring_hosts|length %},{% endif %}{% endfor %} ]
    username: "${ES_MONITORING_USER}"
    password: "${ES_MONITORING_PASS}"
    ssl:
      certificate_authorities: "/usr/share/metricbeat/{{ elasticsearch_certificate_ca_file_ingest }}"
